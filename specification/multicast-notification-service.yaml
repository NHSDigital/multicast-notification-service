# This is an OpenAPI Specification (https://swagger.io/specification/)
# for the multicast-notification-service owned by NHS Digital (https://digital.nhs.uk/)
openapi: '3.0.0'
info:
  title: 'Multicast Notification Service (MNS) - REST API'
  version: 'Computed and injected at build time by `scripts/set_version.py`'
  description: |
    ## Overview
    ![MNS High-level Diagram](https://raw.githubusercontent.com/NHSDigital/multicast-notification-service/master/assets/images/mns-high-level-diagram.svg )

    Use this API to publish and subscribe to patient-related events. The events do not contain clinical information; they simply describe what 
    type of event occured to whom and where. Where possible, a pointer is provided to enable retrieval of the associated payload.
 
    This API is intended for NHS England internal product teams as a means of decoupling systems by providing access to streams of lightweight data from various sources without the need for direct integration.

    You can:
      - Publish events. The first planned use case is GP Registration Change events. The team is actively building a backlog of future event candidates, for example:
        PDS record changes, vaccinations.

    In future, you will be able to:
      - subscribe to events based on certain criteria such as the event type

    Data flow:
      1. An event occurs on a provider system. The provider system sends MNS the event.
      2. MNS extracts key identifying information from the message, enriches it making up the MDS for this signal. Enrichment involves taking the patient identifier, usually the NHS Number, and retrieving related patient records from external services. This allows MNS to add additional information not in the initial event, such as post code of the patient's GP, allowing for more fine grained subscription criteria.
      3. MNS matches the signal against subscribing organisations and delivers it to their specified destinations, for example an AWS Kinesis Firehose.
      4. Consumers can optionally synchronise with event producers to obtain further information.

    Data vs Metadata:
      - Metadata: In the context of an event, metadata refers to the additional information that describes the event and provides context about it. It is data about the data. It helps in tracking events, understanding their origins, and providing information for further processing.
      - Data: Data refers to the main payload of the event or the original record. It contains the actual information that is relevant to the event being processed.
    
    Metadata may not contain all the necessary details needed to make updates to records. When updating local records, subscribers are required to retrieve the complete event/record and then address any differences between the central and local records to ensure accurate updates.

    ## Who can use this API
    This API can only currently be used by internal NHS England services. Make sure you have a valid use case before you go too far with your development. You 
    must do this before you can go live (see ‘Onboarding’ below).

    Note: during beta, this API will only be used by NHS England product teams with a valid use case.
    ## Related APIs
    The following API also provides access to patient-related events:
      - [National Events Management Service - FHIR API](https://digital.nhs.uk/developer/api-catalogue/national-events-management-service-fhir "National 
      Events Management Service - FHIR API") - the difference is that the payloads MNS delivers will be event signals: lightweight events that do not contain any clinical information, they 'signal' a state has changed. NEMS delivers events to external consumer systems whereas MNS is intended only for use by internal NHS England product teams. The two systems will be complementary.
    ## API status and roadmap
    This API is [in development](https://digital.nhs.uk/developer/guides-and-documentation/reference-guide#statuses).

    You can comment, upvote and view progress on our [roadmap](https://nhs-digital-api-management.featureupvote.com/suggestions/440034/multicast-notification-service-event-management-api).
    ## Service level
    The Multicast Service API is currently not in a production environment.
    ## Technology
    This API is a [REST-based](https://digital.nhs.uk/developer/guides-and-documentation/our-api-technologies#basic-rest) [publish-subscribe](https://digital.nhs.uk/developer/guides-and-documentation/introduction-to-healthcare-technology/integration-and-apis#publish-subscribe-events) API.

    The event structure is based on the recommendations of the [Cloud Events specification.](https://cloudevents.io/) [FHIR STU3](https://hl7.org/fhir/stu3/) events can also be published.
    ## Network access
    This API is available on the internet and, indirectly, on the [Health and Social Care Network (HSCN)](https://digital.nhs.uk/services/health-and-social-care-network).

    For more details see [Network access for APIs](https://digital.nhs.uk/developer/guides-and-documentation/network-access-for-apis).
    ## Security and authorisation

    This API has one access mode:
    - application-restricted access

    ### Application-restricted access
    Use this access mode if you need to publish an event from your system.

    This access mode is [application-restricted](https://digital.nhs.uk/developer/guides-and-documentation/security-and-authorisation#application-restricted-apis), meaning we authenticate the calling application but not the end user.

    The end user could be:
    * a healthcare worker - for example they record an event in an application and that application then publishes to MNS
    * a patient - for example they make a change to their record in a patient-facing application and that application then publishes to MNS
    * not present at all - for example as part of a back end process where events from an NHS England product or system are generated

    In the above cases you must ensure the users are authenticated and suitably authorised locally
    
    To use this access mode, use the following security pattern:
    * [Application-restricted RESTful API - signed JWT authentication](https://digital.nhs.uk/developer/guides-and-documentation/security-and-authorisation/application-restricted-restful-apis-signed-jwt-authentication) 

    ## Environments and testing

    | Environment       | Base URL                                                               |
    | ----------------- | ---------------------------------------------------------------------- |
    | Sandbox           | `https://sandbox.api.service.nhs.uk/multicast-notification-service`    |
    | Integration test  | `https://int.api.service.nhs.uk/multicast-notification-service`                                                     |
    | Production        | Not yet available                                                      |

    ### Sandbox testing
    Our [sandbox environment](https://digital.nhs.uk/developer/guides-and-documentation/testing#sandbox-testing):
    * is for early developer testing
    * only covers a limited set of scenarios
    * is stateless, so does not actually persist any updates
    * is open access, so does not allow you to test authorisation

    For details of sandbox test scenarios, or to try out the sandbox using our 'Try this API' feature, see the documentation for each endpoint.

    Alternatively, you can try out the sandbox using our Postman collection (simply download the file from the link and import it into Postman):

        
    [![Run in Postman](https://run.pstmn.io/button.svg)](https://github.com/NHSDigital/multicast-notification-service/blob/master/postman/sandbox/Multicast_Notification_Sandbox.postman_collection.json)
    ## Onboarding
    During the planned private beta this service will only be available to NHS England product teams. The onboarding process is in development and we will be 
    improving it iteratively as we gather feedback from the first set of users.

    ## Errors
    We use standard HTTP status codes to show whether an API request succeeded or not. They are usually in the range:

    * 200 to 299 if it succeeded, including code 202 if it was accepted by an API that needs to wait for further action
    * 400 to 499 if it failed because of a client error by your application
    * 500 to 599 if it failed because of an error on our server
    
    Errors specific to each API are shown in the Endpoints section, under Response. See our [reference guide](https://digital.nhs.uk/developer/guides-and-documentation/reference-guide#http-status-codes) for more on errors.
  contact:
    name: 'multicast-notification-service API Support'
    url: 'https://digital.nhs.uk/developer/help-and-support'
    email: api.management@nhs.net
security: []
servers:
  - url: 'https://sandbox.api.service.nhs.uk/multicast-notification-service'
    description: Sandbox environment.
  - url: 'https://int.api.service.nhs.uk/multicast-notification-service'
    description: Integration test environment.
  - url: 'https://api.service.nhs.uk/multicast-notification-service'
    description: Production environment.
paths:
  /events:
    post:
      summary: "Publish an event"
      description: |
        ### Overview
        Use this endpoint to publish a patient-related event.

        You have the option to provide your payload in a simple non-FHIR JSON event.

        ### Non-FHIR payload (CloudEvent)
        The non-FHIR event contains only a minimum dataset based on the recommendations of the CloudEvents specification. See [https://nhsd-confluence.digital.nhs.uk/display/SPINE/Event+Pattern+-+Event+Structure](https://nhsd-confluence.digital.nhs.uk/display/SPINE/Event+Pattern+-+Event+Structure) for more info.

        ### Sandbox testing
        You can test the following scenarios in our sandbox environment:

        | Scenario                                  | Request                                                                 | Response                                                       |
        | ----------------------------------------- | ----------------------------------------------------------------------- | -------------------------------------------------------------- |
        | Publish an MDS Event (GP Reg Change)      | Content-Type: `application/json` Event Type: `pds-change-of-gp-1`       | HTTP Status 200 and response containing id and success status. |
        | Publish an event with an invalid type     | Any event type other than `pds-change-of-gp-1`                          | HTTP Status 400 and response containing a validation error.    |

        You can try out the sandbox using the 'Try this API' feature on this page.
      operationId: publish-event
      parameters:
        - name: Authorization
          in: header
          description: |-
            An [OAuth 2.0 bearer token](https://digital.nhs.uk/developer/guides-and-documentation/security-and-authorisation/application-restricted-restful-apis-signed-jwt-authentication).
            Required in all environments except sandbox.
          schema:
            type: string
            format: '^Bearer [[:ascii:]]+$'
            example: Bearer g1112R_ccQ1Ebbb4gtHBP1aaaNM
        - name: X-Correlation-ID
          in: header
          description: |-
            An optional ID which you can use to track transactions across multiple systems. It can take any value, but we recommend avoiding `.` characters.
            Mirrored back in a response header.
          schema:
            type: string
            example: 11C46F5F-CDEF-4865-94B2-0EE0EDCC26DA
      requestBody:
        required: true
        content:
          application/json:
            examples:
              withoutData:
                schema:
                  type: "object"
                  required:
                    - "id"
                    - "type"
                    - "subject"
                    - "source"
                    - "time"
                  properties:
                    id:
                      type: "string"
                      example: "236a1d4a-5d69-4fa9-9c7f-e72bf505aa5b"
                      description: "Producers must ensure that the id is unique within their system to ensure that when the MNS team trace messages, they can be certain that source + id will be unique."
                    type:
                      type: "string"
                      example: "pds-change-of-gp-1"
                      description: "A unique string representing the event type. For the initial private beta, the API will only accept `pds-change-of-gp-1`."
                    subject:
                      type: "object"
                      required:
                        - "nhsNumber"
                        - "familyName"
                        - "dob"
                      description: "The NHS patient to whom the event occurred."
                      properties:
                        nhsNumber:
                          type: "string"
                          example: "9912003888"
                          description: "NHS Number validated in line with https://www.datadictionary.nhs.uk/attributes/nhs_number.html."
                        familyName:
                          type: "string"
                          example: "DAWKINS"
                          description: "Last name, capitalised"
                        dob:
                          type: "string"
                          format: "date"
                          example: "2017-10-02"
                          description: "ISO-8601 date."
                    source:
                      type: "object"
                      required:
                        - "name"
                        - "identifier"
                      description: "Organisation responsible for generating the patient-related event."
                      properties:
                        name:
                          type: "string"
                          example: "NHS Digital"
                          description: "Organisation name"
                        identifier:
                          type: "object"
                          required:
                            - "system"
                            - "value"
                          description: "Must follow this identifier system: https://fhir.nhs.uk/Id/nhsSpineASID and provide the ASID Code as the value."
                          properties:
                            system:
                              type: "string"
                              example: "https://fhir.nhs.uk/Id/nhsSpineASID"
                            value:
                              type: "string"
                              example: "477121000324"
                    time:
                      type: "string"
                      format: "date-time"
                      example: "2022-04-05T17:31:00Z"
                      description: "ISO-8601 datetime."

              withData:
                schema:
                  type: "object"
                  required:
                    - "id"
                    - "type"
                    - "subject"
                    - "source"
                    - "time"
                  properties:
                    id:
                      type: "string"
                      example: "236a1d4a-5d69-4fa9-9c7f-e72bf505aa5b"
                      description: "Producers must ensure that the id is unique within their system to ensure that when the MNS team trace messages, they can be certain that source + id will be unique."
                    type:
                      type: "string"
                      example: "pds-change-of-gp-1"
                      description: "A unique string representing the event type. For the initial private beta, the API will only accept `pds-change-of-gp-1`."
                    subject:
                      type: "object"
                      required:
                        - "nhsNumber"
                        - "familyName"
                        - "dob"
                      description: "The NHS patient to whom the event occurred."
                      properties:
                        nhsNumber:
                          type: "string"
                          example: "9912003888"
                          description: "NHS Number validated in line with https://www.datadictionary.nhs.uk/attributes/nhs_number.html."
                        familyName:
                          type: "string"
                          example: "DAWKINS"
                          description: "Last name, capitalised"
                        dob:
                          type: "string"
                          format: "date"
                          example: "2017-10-02"
                          description: "ISO-8601 date."
                    source:
                      type: "object"
                      required:
                        - "name"
                        - "identifier"
                      description: "Organisation responsible for generating the patient-related event."
                      properties:
                        name:
                          type: "string"
                          example: "NHS Digital"
                          description: "Organisation name"
                        identifier:
                          type: "object"
                          required:
                            - "system"
                            - "value"
                          description: "Must follow this identifier system: https://fhir.nhs.uk/Id/nhsSpineASID and provide the ASID Code as the value."
                          properties:
                            system:
                              type: "string"
                              example: "https://fhir.nhs.uk/Id/nhsSpineASID"
                            value:
                              type: "string"
                              example: "477121000324"
                    time:
                      type: "string"
                      format: "date-time"
                      example: "2022-04-05T17:31:00Z"
                      description: "ISO-8601 datetime."
                    data:
                      type: "object"
                      properties: 
                        versionId: 
                          type: "string"
                          example: ' W/"2" '
                          description: "The versionId/ETAG identifies the version of the resource."
                        fullUrl: 
                          type: "string"
                          example: "https://test-api.nhs.uk/personal-demographics/FHIR/R4/Patient/5323035280"
                          description: "The URL where the subscriber can retrieve the source of truth record for the patient or the full event payload."
                        provenance: 
                          type: "object"
                          description: "The provenance describes which actor was responsible for the creation of the event."
                          properties:
                            name: 
                              type: "string"
                              example: "The GP Practice"
                              description: "The GP Practice name"
                            identifier: 
                              type: "object"
                              required:
                              - "system"
                              - "value"
                              description: "Must follow this identifier system: https://fhir.nhs.uk/Id/nhsSpineASID and provide the ASID as the value."
                              properties : 
                                  system: 
                                    type: "string"
                                    example: "https://fhir.nhs.uk/Id/nhsSpineASID"
                                  value: 
                                    type: "string"
                                    example: "477121000323"
         
      responses:
        200:
          description: Success - the event is accepted and will be multicast to subscribers
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    description: Indicates whether or not the action was successful
                    example: true
                  id:
                    type: string
                    description: The id provided in the user's payload
                    example: "236a1d4a-5d69-4fa9-9c7f-e72bf505aa5b"
        400:
          description: Invalid user input
          content:
            application/json:
              schema:
                type: object
                properties:
                  validationErrors:
                    type: object
                    description: Object containing the different errors on a per key basis
                    properties:
                      type:
                        type: string
                        example: Please provide a valid event type
        401:
          description: "TODO - EM-278 - add auth"
        500:
          description: "Internal error"
          content:
            application/json:
              schema:
                type: object
                properties:
                  errors:
                    type: string
                    description: Object containing the different errors on a per key basis
                    example: Internal server error
