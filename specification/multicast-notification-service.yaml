# This is an OpenAPI Specification (https://swagger.io/specification/)
# for the multicast-notification-service owned by NHS Digital (https://digital.nhs.uk/)
openapi: '3.0.0'
info:
  title: 'Multicast Notification Service (MNS) - REST API'
  version: 'Computed and injected at build time by `scripts/set_version.py`'
  description: |
    ## Overview
    ![MNS High-level Diagram](https://raw.githubusercontent.com/NHSDigital/multicast-notification-service/master/assets/images/mns-high-level-diagram.svg )

    Use this API to publish events and subscribe to healthcare-related signals. This API is currently only live with patient-related signals. However, it is intended as a robust service that could support many types of future signals e.g. changes related to healthcare organisations or staff.
    
    The signals do not contain clinical information; they simply describe what type of event occured to whom/what and where. Where possible, a pointer is provided to enable retrieval of the associated payload.

    This API is intended for NHS England internal product teams as a means of decoupling systems by providing access to streams of lightweight data from various sources without the need for direct integration.

    You can:
      - Publish events. The first use case is GP Registration Change events.
      - Subscribe to signals based on criteria such as the event type or patient NHS number. The team is actively building a backlog of future signal candidates, which can be viewed on our [Signal Catalogue page](https://digital.nhs.uk/developer/api-catalogue/multicast-notification-service/signal-catalogue).

    Data flow:
      1. An event occurs on a provider system. The provider system sends MNS the event.
      2. MNS validates that the event conforms to the accepted schema and sends it another component to handle subscription matching and onward delivery.
      3. MNS matches the signal against subscribing organisations and delivers it to their specified destinations, for example an AWS Kinesis Firehose.
      4. Subscribers can optionally synchronise with event publishers to obtain further information.

    ## Who can use this API
    This API can only currently be used by internal NHS England services. Make sure you have a valid use case before you go too far with your development. You
    must do this before you can go live (see ‘Onboarding’ below).

    Note: during beta, this API will only be used by NHS England product teams with a valid use case.
    ## Related APIs
    The following API also provides access to healthcare-related events:
      - [National Events Management Service - FHIR API](https://digital.nhs.uk/developer/api-catalogue/national-events-management-service-fhir "National
      Events Management Service - FHIR API") - the difference is that the payloads MNS delivers will be event signals: lightweight events that do not contain any clinical information, they 'signal' a state has changed. NEMS delivers events to external subscriber systems whereas MNS is intended only for use by internal NHS England product teams. The two systems will be complementary.
    ## API status and roadmap
    This API is [in production (beta)](https://digital.nhs.uk/developer/guides-and-documentation/reference-guide#statuses).

    You can comment, upvote and view progress on our [roadmap](https://nhs-digital-api-management.featureupvote.com/suggestions/440034/multicast-notification-service-event-management-api).
    ## Service level
    This API is a bronze service, meaning it is operational and supported only during business hours (8am to 6pm), Monday to Friday excluding bank holidays.

    For more details, see [service levels](https://digital.nhs.uk/developer/guides-and-documentation/reference-guide#service-levels).
    ## Technology
    This API is a [REST-based](https://digital.nhs.uk/developer/guides-and-documentation/our-api-technologies#basic-rest) [publish-subscribe](https://digital.nhs.uk/developer/guides-and-documentation/introduction-to-healthcare-technology/integration-and-apis#publish-subscribe-events) API.

    The signal structure is based on the recommendations of the [Cloud Events specification.](https://cloudevents.io/)
    ## Network access
    This API is available on the internet and, indirectly, on the [Health and Social Care Network (HSCN)](https://digital.nhs.uk/services/health-and-social-care-network).

    For more details see [Network access for APIs](https://digital.nhs.uk/developer/guides-and-documentation/network-access-for-apis).
    ## Security and authorisation

    This API has one access mode:
    - application-restricted access

    ### Application-restricted access
    Use this access mode if you need to publish an event from your system.

    This access mode is [application-restricted](https://digital.nhs.uk/developer/guides-and-documentation/security-and-authorisation#application-restricted-apis), meaning we authenticate the calling application but not the end user.

    The end user could be:
    * a healthcare worker - for example they record an event in an application and that application then publishes to MNS
    * a patient - for example they make a change to their record in a patient-facing application and that application then publishes to MNS
    * not present at all - for example as part of a back end process where events from an NHS England product or system are generated

    In the above cases you must ensure the users are authenticated and suitably authorised locally

    To use this access mode, use the following security pattern:
    * [Application-restricted RESTful API - signed JWT authentication](https://digital.nhs.uk/developer/guides-and-documentation/security-and-authorisation/application-restricted-restful-apis-signed-jwt-authentication)

    ## Environments and testing

    | Environment       | Base URL                                                               |
    | ----------------- | ---------------------------------------------------------------------- |
    | Sandbox           | `https://sandbox.api.service.nhs.uk/multicast-notification-service`    |
    | Integration test  | `https://int.api.service.nhs.uk/multicast-notification-service`        |
    | Ref Environment   | `https://ref.api.service.nhs.uk/multicast-notification-service`        |
    | Production        | `https://api.service.nhs.uk/multicast-notification-service`            |

    ### Sandbox testing
    Our [sandbox environment](https://digital.nhs.uk/developer/guides-and-documentation/testing#sandbox-testing):
    * is for early developer testing
    * only covers a limited set of scenarios
    * is stateless, so does not actually persist any updates
    * is open access, so does not allow you to test authorisation

    For details of sandbox test scenarios, or to try out the sandbox using our 'Try this API' feature, see the documentation for each endpoint.

    Alternatively, you can try out the sandbox using our Postman collection (simply download the file from the link and import it into Postman):


    [![Run in Postman](https://run.pstmn.io/button.svg)](https://github.com/NHSDigital/multicast-notification-service/blob/master/postman/sandbox/Multicast_Notification_Sandbox.postman_collection.json)
    ## Onboarding
    During the planned private beta this service will only be available to NHS England product teams. The onboarding process is in development and we will be
    improving it iteratively as we gather feedback from the first set of users.

    ## Errors
    We use standard HTTP status codes to show whether an API request succeeded or not. They are usually in the range:

    * 200 to 299 if it succeeded, including code 202 if it was accepted by an API that needs to wait for further action
    * 400 to 499 if it failed because of a client error by your application
    * 500 to 599 if it failed because of an error on our server

    Errors specific to each API are shown in the Endpoints section, under Response. See our [reference guide](https://digital.nhs.uk/developer/guides-and-documentation/reference-guide#http-status-codes) for more on errors.

    ## Open source
    You might find the following [open source](https://digital.nhs.uk/developer/guides-and-documentation/reference-guide#open-source) resources useful:

    | Resource                  | Description                                                          | Links                                                                       |
    |---------------------------|----------------------------------------------------------------------|-----------------------------------------------------------------------------|
    | MNS API                   | Source code for the API proxy, sandbox and specification.            | [GitHub repo](https://github.com/NHSDigital/multicast-notification-service) |
    | FHIR libraries and SDKs   | Various open source libraries for integrating with FHIR APIs.        | [FHIR libraries and SDKs](https://digital.nhs.uk/developer/guides-and-documentation/api-technologies-at-nhs-digital#fhir-libraries-and-sdks) |

    We currently don't have any open source client libraries or sample code for this API. If you think this would be useful, you can [upvote the suggestion on our Interactive Product Backlog](https://nhs-digital-api-management.featureupvote.com/suggestions/107439/client-libraries-and-reference-implementations).

    The source code for the MNS back end is not currently in the open. If you think this would be useful, you can [upvote the suggestion on our Interactive Product Backlog](https://nhs-digital-api-management.featureupvote.com/suggestions/525770/open-source-the-multicast-notification-service-back-end-repo).
  contact:
    name: 'multicast-notification-service API Support'
    url: 'https://digital.nhs.uk/developer/help-and-support'
    email: api.management@nhs.net
security: []
servers:
  - url: 'https://sandbox.api.service.nhs.uk/multicast-notification-service'
    description: Sandbox environment.
  - url: 'https://int.api.service.nhs.uk/multicast-notification-service'
    description: Integration test environment.
  - url: 'https://api.service.nhs.uk/multicast-notification-service'
    description: Production environment.
paths:
  /events:
    post:
      summary: "Publish an event"
      description: |
        ### Overview
        Use this endpoint to publish a healthcare-related event.

        The event contains only a minimum dataset based on the recommendations of the [CloudEvents specification](https://github.com/cloudevents/spec/blob/v1.0.2/cloudevents/spec.md).

        ### Data and Metadata:
          - Metadata: In the context of an event, metadata refers to the additional information that describes the event and provides context about it. For example, for [PDS](https://digital.nhs.uk/services/personal-demographics-service) events it includes elements such as the family name and date of birth which are primarily for verification. Users must be cautious not to use such metadata to modify a patient's demographic details. Instead, if updates are necessary, users should conduct a full PDS retrieval to ensure accuracy and completeness in their workflows.
          - Data: The inclusion of the data field might vary. Its presence is subject to agreements between the MNS team and the originating system. While the structure of the data might differ across various systems and scenarios, it's a general preference to have a pointer included. This pointer aids subscribers in accessing the entire record when necessary for their workflow.

        ### Sandbox testing
        You can test the following scenarios in our sandbox environment:

        | Scenario                                  | Request                                                                 | Response                                                       |
        | ----------------------------------------- | ----------------------------------------------------------------------- | -------------------------------------------------------------- |
        | Publish a GP Registration Change event    | Content-Type: `application/json` Event Type: `pds-change-of-gp-1`       | HTTP Status 200 and response containing id and success status. |
        | Publish a GP Death event                  | Content-Type: `application/json` Event Type: `pds-death-notification-1` | HTTP Status 200 and response containing id and success status. |
        | Publish an NHS Number Change event        | Content-Type: `application/json` Event Type: `nhs-number-change-1`      | HTTP Status 200 and response containing id and success status. |
        | Publish an Immunisation Vaccination event | Content-Type: `application/json` Event Type: `imms-vaccinations-1`      | HTTP Status 200 and response containing id and success status. |
        | Publish an event with invalid data        | E.g. an event with an invalid value for `time`                          | HTTP Status 400 and response containing a validation error.    |

        You can try out the sandbox using the 'Try this API' feature on this page.
      operationId: publish-event
      parameters:
        - name: Authorization
          in: header
          required: true
          description: |-
            An [OAuth 2.0 bearer token](https://digital.nhs.uk/developer/guides-and-documentation/security-and-authorisation/application-restricted-restful-apis-signed-jwt-authentication).
            Required in all environments except sandbox.
          schema:
            type: string
            format: '^Bearer [[:ascii:]]+$'
            example: Bearer g1112R_ccQ1Ebbb4gtHBP1aaaNM
        - name: X-Correlation-ID
          in: header
          required: true
          description: |-
            An ID which is used to track transactions across multiple systems. It can take any value, but we recommend avoiding `.` characters.
            Mirrored back in a response header.
          schema:
            type: string
            example: 11C46F5F-CDEF-4865-94B2-0EE0EDCC26DA
      requestBody:
        required: true
        content:
          application/cloudevents+json:
            schema:
              oneOf:
                - $ref: "#/components/schemas/gpreg-change-gp-req-1"
              discriminator:
                propertyName: type
            examples:
              gpreg-change-gp-req-1:
                description: "Create a GP Registration Change event"
                value:
                  specversion: '1.0'
                  id: 236a1d4a-5d69-4fa9-9c7f-e72bf505aa5b
                  source: uk.nhs.register-with-a-gp-surgery-service
                  type: gpreg-change-gp-req-1
                  time: '2020-06-01T13:00:00Z'
                  dataref: https://api.service.nhs.uk/register-with-a-gp-surgery/applications/236a1d4a-5d69-4fa9-9c7f-e72bf505aa5b
                  subject: '9912003888'
                  filtering:
                    registrationencountercode: '3'
                    generalpracticecode: 'XY11'
          application/json:
            schema:
              type: "object"
              required:
                - "id"
                - "type"
                - "subject"
                - "source"
                - "time"
              properties:
                id:
                  type: "string"
                  description: "Publishers must ensure that the id is unique within their system to ensure that when the MNS team trace messages, they can be certain that source + id will be unique. UUIDv4 format is expected."
                type:
                  type: "string"
                  description: "A unique string representing the event type."
                subject:
                  type: "object"
                  description: |
                    The healthcare entity to which the event occurred. For example, this could be an NHS organisation or a person such as an NHS patient or member of staff.
                    We currently only have a schema for a patient as a subject but will work with you to agree a new schema if you have a different use case."
                  oneOf:
                    - $ref: "components/schemas/cloudevents/eventSubjectPatientExample.yaml"
                source:
                  type: "object"
                  required:
                    - "name"
                    - "identifier"
                  description: "Organisation responsible for publishing the event."
                  properties:
                    name:
                      type: "string"
                      description: "Organisation name"
                    identifier:
                      type: "object"
                      required:
                        - "system"
                        - "value"
                      description: "Must follow this identifier system: https://fhir.nhs.uk/Id/nhsSpineASID and provide the ASID Code as the value."
                      properties:
                        system:
                          type: "string"
                        value:
                          type: "string"
                time:
                  type: "string"
                  format: "date-time"
                  description: "The time at which the signal is published. This must be a compliant RFC3339 datetime in line with the FHIR standard for [system instants](https://hl7.org/fhir/R4/datatypes.html#instant). This means it can have seconds or milliseconds precision."
                data:
                  type: object
                  description: "This field is optional, dependent on the agreements between the publishing system and the MNS team. While the data schema might vary based on the system and use-case, it is preferred to include a pointer for subscribers to access the full record when necessary for their workflow."
                  oneOf:
                    - $ref: "components/schemas/cloudevents/pdsChangeOfGpEventData.yaml"
                    - $ref: "components/schemas/cloudevents/pdsDeathEventData.yaml"
                    - $ref: "components/schemas/cloudevents/nhsNumberChangeEventData.yaml"
                    - $ref: "components/schemas/cloudevents/immunisationVaccinationEventData.yaml"
            examples:
              pdsChangeOfGpEvent:
                description: "Create a PDS change of GP signal event"
                value:
                  id: "236a1d4a-5d69-4fa9-9c7f-e72bf505aa5b"
                  type: "pds-change-of-gp-1"
                  subject:
                    nhsNumber: "9912003888"
                    familyName: "DAWKINS"
                    dob: "2017-10-02"
                  source:
                    name: "NHS Digital"
                    identifier:
                      system: "https://fhir.nhs.uk/Id/nhsSpineASID"
                      value: "477121000324"
                  time: "2022-04-05T17:31:00.000Z"
                  data:
                    versionId: 'W/"2"'
                    fullUrl: "https://int.api.service.nhs.uk/personal-demographics/FHIR/R4/Patient/9912003888"
                    registrationEncounterCode: "3"
                    provenance:
                      name: "The GP Practice"
                      identifier:
                        system: "https://fhir.nhs.uk/Id/nhsSpineASID"
                        value: "477121000323"
              pdsDeathEvent:
                value:
                  id: "236a1d4a-5d69-4fa9-9c7f-e72bf505aa5b"
                  type: "pds-death-notification-1"
                  subject:
                    dob: "2017-10-02"
                    familyName: "DAWKINS"
                    nhsNumber: "9912003888"
                  source:
                    name: "NHS DIGITAL"
                    identifier:
                      system: "https://fhir.nhs.uk/Id/nhsSpineASID"
                      value: "477121000324"
                  time: "2022-04-05T17:31:00.000Z"
                  data:
                    versionId: 'W/"16"'
                    fullUrl: "https://int.api.service.nhs.uk/personal-demographics/FHIR/R4/Patient/9912003888"
                    deathNotificationStatus: "2"
                    provenance:
                      name: "The GP Practice"
                      identifier:
                        system: "https://fhir.nhs.uk/Id/nhsSpineASID"
                        value: "477121000323"
              nhsNumberChangeEvent:
                value:
                  id: "dd822a88-959c-416c-86e0-652a48c5a810"
                  type: "nhs-number-change-1"
                  subject:
                    dob: "2017-10-02"
                    familyName: "DAWKINS"
                    nhsNumber: "9912003888"
                  source:
                    name: "NHS DIGITAL"
                    identifier:
                      system: "https://fhir.nhs.uk/Id/nhsSpineASID"
                      value: "477121000324"
                  time: "2022-04-05T17:31:00.000Z"
                  data:
                    versionId: 'W/"16"'
                    fullUrl: "https://int.api.service.nhs.uk/personal-demographics/FHIR/R4/Patient/9912003888"
                    nhsNumberStatus: "I"
                    provenance:
                      name: "The GP Practice"
                      identifier:
                        system: "https://fhir.nhs.uk/Id/nhsSpineASID"
                        value: "477121000323"
              immunisationVaccinationEvent:
                value:
                  id: "93d3f828-c6d2-43eb-95c2-f98f7c7ed889"
                  type: "imms-vaccinations-1"
                  subject:
                    dob: "2017-10-02"
                    familyName: "DAWKINS"
                    nhsNumber: "9912003888"
                  source:
                    name: "NHS DIGITAL"
                    identifier:
                      system: "https://fhir.nhs.uk/Id/immunisationsASID"
                      value: "477121000324"
                  time: "2022-04-05T17:31:00.000Z"
                  data:
                    versionId: 'W/"1"'
                    fullUrl: "https://int.api.service.nhs.uk/immunisation-fhir-api/Immunization?patient.identifier=https%3A%2F%2Ffhir.nhs.uk%2FId%2Fnhs-number%7C9912003888"
                    immunisationType: "FLU"
                    provenance:
                      name: "The GP Practice"
                      identifier:
                        system: "https://fhir.nhs.uk/Id/orignatorOfRecordASID"
                        value: "477121000323"
              mnsEventMetaDataOnly:
                value:
                  id: "236a1d4a-5d69-4fa9-9c7f-e72bf505aa5b"
                  type: "possible-future-event-containing-no-data-field"
                  subject:
                    nhsNumber: "A new subject schema would need to be proposed for subjects other than patients."
                    familyName: "DAWKINS"
                    dob: "2017-10-02"
                  source:
                    name: "NHS Digital"
                    identifier:
                      system: "https://fhir.nhs.uk/Id/nhsSpineASID"
                      value: "477121000324"
                  time: "2022-04-05T17:31:00.000Z"

      responses:
        200:
          description: Success - the event is accepted and will be multicast to subscribers
          content:
            application/json:
              schema:
                type: object
                properties:
                  id:
                    type: string
                    description: The id provided in the user's payload
                    example: "236a1d4a-5d69-4fa9-9c7f-e72bf505aa5b"
        400:
          description: Invalid user input
          content:
            application/json:
              schema:
                type: object
                properties:
                  validationErrors:
                    type: object
                    description: Object containing the different errors on a per key basis
                    properties:
                      type:
                        type: string
                        example: Please provide a valid event type
        401:
          $ref: "components/errors/unauthenticated-error.yaml"
        403:
          description: "Unauthorized error"
          content:
            application/json:
              schema:
                type: object
                properties:
                  errors:
                    type: string
                    description: Error string that explains the problem
                    example: User is not authorized to handle the requested event type
        500:
          $ref: "components/errors/internal-error.yaml"
  /subscriptions:
    post:
      summary: "Subscribe to events"
      description: |
        ### Overview
        Use this endpoint to subscribe to healthcare-related signals. You can view details of the available signals on our [Signal Catalogue page](https://digital.nhs.uk/developer/api-catalogue/multicast-notification-service/signal-catalogue).
        
        ### Subscription filtering
        You can filter the signals you want to receive using the `criteria` field in the payload. As a minimum, you must specify the signal type. For example, if you provide `eventType=pds-change-of-gp-1`
        this will mean that you receive all PDS Change of GP events. Currently the only additional filter you can use is NHS Number. We are working with subscribers during private beta to identify any other useful
        filters. There may be further filters available in future.

        For further information refer to the payload schema below.

        ### Subscription delivery
        You can specify the endpoint you want signals delivered to using the `channel.endpoint` field in the payload. MNS currently only supports delivery to [AWS SQS](https://aws.amazon.com/sqs/) endpoints and
        [MESH](https://digital.nhs.uk/services/message-exchange-for-social-care-and-health-mesh) mailboxes. We are working with users during private beta to identify other potential delivery endpoints.
        There may be further delivery endpoints available in future.

        You can make suggestions using [feature upvote](https://nhs-digital-api-management.featureupvote.com).

        #### SQS Delivery
        Before signals can be delivered to your SQS queue, you will need to complete some configuration steps during onboarding e.g. policy and encryption setup. When you make a create subscription request, you must provide your
        full SQS ARN.

        #### MESH Delivery
        You will need to provide the ID of your MESH mailbox during onboarding. If you have already completed [MESH onboarding](https://digital.nhs.uk/developer/api-catalogue/message-exchange-for-social-care-and-health-api#overview--end-to-end-process-to-integrate-with-mesh-api)
        then no further steps will be required aside from calling the subscriptions API. Use a MESH mailbox from their 'Path to Live integration' environment for all non-production MNS environments and a production mailbox for production MNS.

        ### Sandbox testing
        You can test the following scenarios in our sandbox environment:

        | Scenario                                  | Request                                                                  | Response                                                                    |
        | ----------------------------------------- | ------------------------------------------------------------------------ | --------------------------------------------------------------------------- |
        | Subscribe to GP registration changes      | Content-Type: `application/fhir+json`                                    | HTTP Status 201 and response containing the id of the subscription created. |
        | Subscribe to NHS number changes           | Content-Type: `application/fhir+json`                                    | HTTP Status 201 and response containing the id of the subscription created. |
        | Subscribe to PDS death notifications      | Content-Type: `application/fhir+json`                                    | HTTP Status 201 and response containing the id of the subscription created. |
        | Publish a subscription with invalid data  | E.g. modify the subscription to have an invalid value for `resourceType` | HTTP Status 400 and response containing a validation error.                 |

        You can try out the sandbox using the 'Try this API' feature on this page.
      operationId: create-subscription
      parameters:
        - name: Authorization
          in: header
          required: true
          description: |-
            An [OAuth 2.0 bearer token](https://digital.nhs.uk/developer/guides-and-documentation/security-and-authorisation/application-restricted-restful-apis-signed-jwt-authentication).
            Required in all environments except sandbox.
          schema:
            type: string
            format: '^Bearer [[:ascii:]]+$'
            example: Bearer g1112R_ccQ1Ebbb4gtHBP1aaaNM
        - name: X-Correlation-ID
          in: header
          required: true
          description: |-
            An ID which is used to track transactions across multiple systems. It can take any value, but we recommend avoiding `.` characters.
            Mirrored back in a response header.
          schema:
            type: string
            example: 11C46F5F-CDEF-4865-94B2-0EE0EDCC26DA
      requestBody:
        required: true
        content:
          application/fhir+json:
            schema:
              type: "object"
              required:
                - "resourceType"
                - "status"
                - "reason"
                - "criteria"
                - "channel"
              properties:
                resourceType:
                  type: "string"
                  description: "The subscription FHIR Resource: https://hl7.org/fhir/R4/subscription.html"
                status:
                  type: "string"
                  description: "The status of the subscription. When creating a subscription, the value must be `requested`."
                end:
                  type: "string"
                  format: "date-time"
                  description: |
                    Optional expiry date/time for the subscription. As per the [FHIR R4 instant data type](https://hl7.org/fhir/R4/datatypes.html#instant) time shall be specified to at least the second and include a time zone.
                    For example: YYYY-MM-DDThh:mm:ss.sss+zz:zz (e.g. 2015-02-07T13:28:17.239+02:00 or 2017-01-01T00:00:00Z)"
                reason:
                  type: "string"
                  description: "A description of why this subscription is required. You may provide an empty string."
                criteria:
                  type: "string"
                  description: |
                    Criteria for the subscription. Provide your criteria with each condition separated by `&;`. If you are requesting a generic subscription to all signals of a certain type the separator is not required. For example, `eventType=pds-change-of-gp-1&;patient.identifier=477121000324`
                    or `eventType=pds-change-of-gp-1`. A valid criteria must contain a permitted value for `eventType`. The only additional criteria that MNS currently supports is `patient.identifier` (NHS Number)."
                channel:
                  type: "object"
                  required:
                    - "type"
                    - "endpoint"
                    - "payload"
                  description: "The channel on which to report matches to the criteria. SQS Endpoints must be unique per event type; attempts to add a subscription with an endpoint which is already in-use will fail with a HTTP 409 (Conflict)"
                  properties:
                    type:
                      type: "string"
                      description: "The type of channel to send notifications on. Of the options within [FHIR](https://hl7.org/fhir/R4/valueset-subscription-channel-type.html), MNS currently only supports `message`."
                    endpoint:
                      type: "string"
                      description: "The endpoint which signals will be delivered to. MNS currently only supports delivery to [MESH](https://digital.nhs.uk/services/message-exchange-for-social-care-and-health-mesh) mailboxes and [AWS SQS](https://aws.amazon.com/sqs/) endpoints. Note: for MESH delivery you must provide the full mailbox ID and for SQS delivery you must provide the full SQS ARN of your desired queue."
                    payload:
                      type: "string"
                      description: "The mime type to send the payload in. MNS supports `application/json` and `application/fhir+json` (FHIR R4 Bundle)."
                hydration:
                  type: "object"
                  required:
                    - "enabled"
                  description: "Optional block to configure hydration properties - hydration is disabled by default."
                  properties:
                    enabled:
                      type: "boolean"
                      description: "A flag to enable (true) or disable (false) signal hydration."
                    headers:
                      type: object
                      description: "An optional dictionary of HTTP headers that will be sent in the request to the API endpoint specified in the signal."
                      additionalProperties:
                        type: string
                        description: "HTTP header that will be sent in the request to the API endpoint specified in the signal."
            examples:
              pdsChangeofGPSubscription:
                description: "Create a pds change of GP subscription"
                value:
                  resourceType: "Subscription"
                  status: "requested"
                  end: "2022-04-05T17:31:00.000Z"
                  reason: "A description of why this subscription should be created."
                  criteria: "eventType=pds-change-of-gp-1&;patient.identifier=477121000324"
                  channel:
                    type: "message"
                    endpoint: "arn:aws:sqs:eu-west-2:123456789012:queue1"
                    payload: "application/json"
              pdsChangeofGPSubscriptionMeshDelivery:
                description: "Create a pds change of GP subscription with MESH delivery"
                value:
                  resourceType: "Subscription"
                  status: "requested"
                  end: "2022-04-05T17:31:00.000Z"
                  reason: "A description of why this subscription should be created."
                  criteria: "eventType=pds-change-of-gp-1"
                  channel:
                    type: "message"
                    endpoint: "MYMAILBOXOT101"
                    payload: "application/json"
              nhsNumberChangeSubscription:
                description: "Create an NHS number change subscription"
                value:
                  resourceType: "Subscription"
                  status: "requested"
                  end: "2022-04-05T17:31:00.000Z"
                  reason: "A description of why this subscription should be created."
                  criteria: "eventType=nhs-number-change-1&;patient.identifier=477121000324"
                  channel:
                    type: "message"
                    endpoint: "arn:aws:sqs:eu-west-2:123456789012:queue2"
                    payload: "application/json"
              pdsDeathNotificationSubscription:
                description: "Create a pds death notification subscription"
                value:
                  resourceType: "Subscription"
                  status: "requested"
                  end: "2022-04-05T17:31:00.000Z"
                  reason: "A description of why this subscription should be created."
                  criteria: "eventType=pds-death-notification-1&;patient.identifier=477121000324"
                  channel:
                    type: "message"
                    endpoint: "arn:aws:sqs:eu-west-2:123456789012:queue2"
                    payload: "application/fhir+json"
              immunisationVaccinationSubscription:
                description: "Create an immunisation vaccination subscription"
                value:
                  resourceType: "Subscription"
                  status: "requested"
                  end: "2022-04-05T17:31:00.000Z"
                  reason: "A description of why this subscription should be created."
                  criteria: "eventType=imms-vaccinations-1&;patient.identifier=477121000324"
                  channel:
                    type: "message"
                    endpoint: "arn:aws:sqs:eu-west-2:123456789012:queue2"
                    payload: "application/json"

      responses:
        201:
          description: Created - the subscription has been successfully created
          content:
            application/json:
              schema:
                type: object
                properties:
                  id:
                    type: string
                    description: The subscription UUID created by the system
                    example: "236a1d4a-5d69-4fa9-9c7f-e72bf505aa5b"
        400:
          description: Invalid user input
          content:
            application/json:
              schema:
                type: object
                properties:
                  validationErrors:
                    type: object
                    description: Object containing the different errors on a per key basis
                    properties:
                      resourceType:
                        type: string
                        example: Please provide the correct resource type for this endpoint
        401:
          $ref: "components/errors/unauthenticated-error.yaml"
        403:
          description: "Unauthorized error"
          content:
            application/json:
              schema:
                type: object
                properties:
                  errors:
                    type: string
                    description: Error string that explains the problem
                    example: User is not authorized to handle the requested data type
        409:
          description: "Resource conflict"
          content:
            application/json:
              schema:
                type: object
                properties:
                  errors:
                    type: string
                    description: Error string that explains the problem
                    example: Endpoint arn:aws:sqs:eu-west-2:12345:queue-name is already subscribed for pds-change-of-gp-1 events
        500:
          $ref: "components/errors/internal-error.yaml"

    get:
      summary: "Get all subscriptions"
      description: |
        ### Overview
        Use this endpoint to retrieve a list of all subscriptions belonging to you.
        If your application does not own any subscriptions, then this endpoint will return an empty list.
        The list of subscriptions is presented in a FHIR resource bundle, allowing pagination. 
        ### Sandbox testing
        You can test the following scenarios in our sandbox environment:
        | Scenario                                  | Request                                                                  | Response                                                                    |
        | ----------------------------------------- | ------------------------------------------------------------------------ | --------------------------------------------------------------------------- |
        | User has a list of subscriptions          | `GET` request                                                            | HTTP Status 200 containing a list of subscription resources                 |
        You can try out the sandbox using the 'Try this API' feature on this page.
      operationId: get-all-subscriptions
      parameters:
        - name: Authorization
          in: header
          required: true
          description: |-
            An [OAuth 2.0 bearer token](https://digital.nhs.uk/developer/guides-and-documentation/security-and-authorisation/application-restricted-restful-apis-signed-jwt-authentication).
            Required in all environments except sandbox.
          schema:
            type: string
            format: '^Bearer [[:ascii:]]+$'
            example: Bearer g1112R_ccQ1Ebbb4gtHBP1aaaNM
        - name: X-Correlation-ID
          in: header
          required: true
          description: |-
            An ID which is used to track transactions across multiple systems. It can take any value, but we recommend avoiding `.` characters.
            Mirrored back in a response header.
          schema:
            type: string
            example: 11C46F5F-CDEF-4865-94B2-0EE0EDCC26DA
        - name: continue_from
          in: query
          required: false
          description: |-
            An optional query string parameter used for pagination, specifying the point from which to continue the list.
          schema:
            type: string
      responses:
        200:
          description: Successfully retrieved list of subscriptions
          content:
            application/fhir+json:
              schema:
                type: object
                properties:
                  resourceType:
                    type: string
                    enum: [Bundle]
                  type:
                    type: string
                    enum: [searchset]
                  link:
                    type: array
                    items:
                      type: object
                      properties:
                        relation:
                          type: string
                          description: Relation type, e.g., 'self', 'next'. The 'next' relation is present only if there's additional content to paginate through.
                        url:
                          type: string
                          description: The URL for the relation. For 'next', this URL points to the next page of results.
                      example:
                        relation: next
                        url: '/subscriptions?continue_from=ZmRqa2xmZGprc2xmamtsZHNqZmxkc2Zkcw=='
                  entry:
                    type: array
                    items:
                      $ref: "components/schemas/fhir/R4/Subscription.yaml"
        400:
          description: Invalid user input
          content:
            application/json:
              schema:
                type: object
                properties:
                  errors:
                    type: string
                    description: Error string that explains the problem
                    example: The continue_from field was not valid
        401:
          $ref: "components/errors/unauthenticated-error.yaml"
        403:
          $ref: "components/errors/unauthorised-error.yaml"
        500:
          $ref: "components/errors/internal-error.yaml"
  /subscriptions/{id}:
    get:
      summary: "Get subscription details"
      description: |
        ### Overview
        Use this endpoint to retrieve details of a subscription belonging to you.
        ### Sandbox testing
        You can test the following scenarios in our sandbox environment:
        | Scenario                                  | Request                                                                  | Response                                                                    |
        | ----------------------------------------- | ------------------------------------------------------------------------ | --------------------------------------------------------------------------- |
        | Subscription exists and can be retrieved  | `id=e9050741-ae87-4720-beb1-2abd9248e227`                                | HTTP Status 200 containing subscription details                             |
        | Subscription does not exist               | `id=236a1d4a-5d69-4fa9-9c7f-e72bf505aa5b` (or any other valid UUID)      | HTTP Status 404 containing problem description                              |
        You can try out the sandbox using the 'Try this API' feature on this page.
      operationId: get-subscription-by-id
      parameters:
        - name: Authorization
          in: header
          required: true
          description: |-
            An [OAuth 2.0 bearer token](https://digital.nhs.uk/developer/guides-and-documentation/security-and-authorisation/application-restricted-restful-apis-signed-jwt-authentication).
            Required in all environments except sandbox.
          schema:
            type: string
            format: '^Bearer [[:ascii:]]+$'
            example: Bearer g1112R_ccQ1Ebbb4gtHBP1aaaNM
        - name: X-Correlation-ID
          in: header
          required: true
          description: |-
            An ID which is used to track transactions across multiple systems. It can take any value, but we recommend avoiding `.` characters.
            Mirrored back in a response header.
          schema:
            type: string
            example: 11C46F5F-CDEF-4865-94B2-0EE0EDCC26DA
        - name: id
          in: path
          required: true
          description: The ID of the subscription you want to retrieve. The ID will be a valid UUID (v4).
          schema:
            type: string
            example: e9050741-ae87-4720-beb1-2abd9248e227
      responses:
        200:
          description: Successfully got subscription details
          content:
            application/fhir+json:
              schema:
                $ref: "components/schemas/fhir/R4/Subscription.yaml"
        400:
          description: Invalid user input
          content:
            application/json:
              schema:
                type: object
                properties:
                  errors:
                    type: string
                    description: Error string that explains the problem
                    example: Please provide a valid subscription ID
        401:
          $ref: "components/errors/unauthenticated-error.yaml"
        403:
          $ref: "components/errors/unauthorised-error.yaml"
        404:
          $ref: "components/errors/not-found-error.yaml"
        500:
          $ref: "components/errors/internal-error.yaml"
    delete:
      summary: "Delete a subscription"
      description: |
        ### Overview
        Use this endpoint to delete a subscription that you need to remove.

        ### Sandbox testing
        You can test the following scenarios in our sandbox environment:

        | Scenario                                  | Request                                                                  | Response                                                                    |
        | ----------------------------------------- | ------------------------------------------------------------------------ | --------------------------------------------------------------------------- |
        | Subscription exists and can be deleted    | `id=e9050741-ae87-4720-beb1-2abd9248e227`                                | HTTP Status 204 resource deleted response                                    |
        | Subscription does not exist               | `id=236a1d4a-5d69-4fa9-9c7f-e72bf505aa5b` (or any other valid UUID)      | HTTP Status 404 containing problem description                              |

        You can try out the sandbox using the 'Try this API' feature on this page.
      operationId: delete-subscription
      parameters:
        - name: Authorization
          in: header
          required: true
          description: |-
            An [OAuth 2.0 bearer token](https://digital.nhs.uk/developer/guides-and-documentation/security-and-authorisation/application-restricted-restful-apis-signed-jwt-authentication).
            Required in all environments except sandbox.
          schema:
            type: string
            format: '^Bearer [[:ascii:]]+$'
            example: Bearer g1112R_ccQ1Ebbb4gtHBP1aaaNM
        - name: X-Correlation-ID
          in: header
          required: true
          description: |-
            An ID which is used to track transactions across multiple systems. It can take any value, but we recommend avoiding `.` characters.
            Mirrored back in a response header.
          schema:
            type: string
            example: 11C46F5F-CDEF-4865-94B2-0EE0EDCC26DA
        - name: id
          in: path
          required: true
          description: The ID of the subscription you want to delete. The ID will be a valid UUID (v4).
          schema:
            type: string
            example: e9050741-ae87-4720-beb1-2abd9248e227
      responses:
        204:
          description: The subscription was deleted
        400:
          description: Invalid user input
          content:
            application/json:
              schema:
                type: object
                properties:
                  errors:
                    type: string
                    description: Error string that explains the problem
                    example: Please provide a valid subscription ID
        401:
          $ref: "components/errors/unauthenticated-error.yaml"
        403:
          $ref: "components/errors/unauthorised-error.yaml"
        404:
          $ref: "components/errors/not-found-error.yaml"
        500:
          $ref: "components/errors/internal-error.yaml"
components:
  schemas:
    cloudevent:
      $ref: "components/schemas/cloudevents/baseMnsCloudEventSignal.yaml"
      discriminator:
        propertyName: type
    gpreg-change-gp-req-1:
      description: gpreg-change-gp-req-1
      allOf:
        - $ref: "#/components/schemas/cloudevent"
        - type: object
          properties:
            filtering:
              $ref: "components/schemas/filtering/gpreg-change-gp-req-1-filtering.yaml"
          required:
            - filtering
            - subject
